<!DOCTYPE html>
<html>
  <head>
    <title>Megogo</title>
  </head>
  <body>
    <div id="phonebook"></div>
  </body>

  <script src="js/jquery-min.js"></script>
  <script src="js/underscore-min.js"></script>
  <script src="js/backbone-min.js"></script>
  <script src="js/router.js"></script>

  <script>
  	var Person = Backbone.Model.extend({
      url : 'api2.php'
    });
  	var PhoneBook = Backbone.Collection.extend({
  		model : Person,
  		// url : 'js/phonebook.json',
      url : 'api2.php'
  	});

  	var phoneBook = new PhoneBook;

  	phoneBook.fetch({reset : true});

		phoneBook.bind('reset', function () { console.log('phoneBook'); });

		var PhoneBookView = Backbone.View.extend({
      el: "body",
      initialize : function(){
        var self = this;
        self.render();
      },
      events : {
        'click .action-edit-person' : 'editPerson'
      },
      render: function(e) {
        var self = this;

      	$.get('templates/phoneBook.html', function (data) {
            template = _.template(data);
            $(self.el).html(template({collection : phoneBook.toJSON()}));  
        }, 'html');
      },
      editPerson : function(e) {
        new EditPersonView({
          id : $(e.currentTarget).data('id')
        });
      }
    });

    var EditPersonView = Backbone.View.extend({
      el: 'body',
      initialize : function(params){
        var self = this;
        for (param in params) this[param] = params[param];
        self.render();
      },
      events : {
        'click .action-save-changes' : 'saveChanges'
      },
      render: function(e) {
        var self = this;

        var person = phoneBook.get(self.id);

        $.get('templates/editPerson.html', function (data) {
            template = _.template(data);
            $(self.el).html(template({person : person.toJSON()}));  
        }, 'html');
      },
      saveChanges : function(e) {
        e.preventDefault();

        var changeModel = phoneBook.get($('#personId').val());

        changeModel.set({
          name:$('#personName').val(),
          tel:$('#personTel').val()
        });

        var data = {
          id:changeModel.get('id'),
          name:changeModel.get('name'),
          tel:changeModel.get('tel')
        };

        Backbone.ajax = $.post(changeModel.url, data);
        //Backbone.sync('update', changeModel);
      }
    });


    var router = new MainRouter();
    Backbone.history.start({pushState: false});


  </script>
</html>